name: CI

on:
  pull_request:
  push:
    branches:
      - master
      - main
      - 'codex/**'
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  package-tests:
    runs-on: macos-15
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app
      - name: Swift version
        run: swift --version
      - name: Build
        run: swift build --build-tests
      - name: Test
        run: swift test --enable-code-coverage
      - name: Coverage gate
        run: ./scripts/check_coverage.sh 80
      - name: Prototype smoke run
        run: swift run HSOPrototype
      - name: Lint (if installed)
        run: |
          if command -v swiftlint >/dev/null; then
            swiftlint
          else
            echo "swiftlint not installed on runner"
          fi

  ios-tests:
    runs-on: macos-15
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app
      - name: Resolve iOS test destination
        id: simulator
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq is required to parse xcodebuild destinations."
            exit 1
          fi
          DEST_JSON="$(
            xcodebuild -project HomeScreenOptimizerApp.xcodeproj -scheme HomeScreenOptimizeriOS -showdestinations -json 2>/dev/null \
              | awk 'BEGIN { emit = 0 } /^[[:space:]]*[\[{]/ { emit = 1 } emit { print }'
          )"
          if [[ -z "${DEST_JSON}" ]]; then
            echo "xcodebuild did not return destination JSON."
            exit 1
          fi
          DESTINATION="$(
            printf '%s' "${DEST_JSON}" \
              | jq -r '.. | objects | .destinations? // empty | .[] | select(.platform == "iOS Simulator" and (.name | startswith("iPhone")) and ((.error // null) == null)) | "platform=iOS Simulator,id=\(.id)"' \
              | head -n 1
          )"
          if [[ -z "${DESTINATION}" ]]; then
            echo "No available iPhone simulator destination found on runner."
            exit 1
          fi
          echo "destination=${DESTINATION}" >> "${GITHUB_OUTPUT}"
      - name: Run iOS tests (unit + UI)
        run: |
          set -euo pipefail
          xcodebuild \
            -project HomeScreenOptimizerApp.xcodeproj \
            -scheme HomeScreenOptimizeriOS \
            -destination "${{ steps.simulator.outputs.destination }}" \
            -resultBundlePath TestResults.xcresult \
            test
      - name: Upload iOS test bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-results
          path: TestResults.xcresult
          if-no-files-found: warn
