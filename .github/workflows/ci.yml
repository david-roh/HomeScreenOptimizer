name: CI

on:
  pull_request:
  push:
    branches:
      - master
      - main
      - 'codex/**'
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  package-tests:
    runs-on: macos-15
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app
      - name: Swift version
        run: swift --version
      - name: Build
        run: swift build --build-tests
      - name: Test
        run: swift test --enable-code-coverage
      - name: Coverage gate
        run: ./scripts/check_coverage.sh 80
      - name: Prototype smoke run
        run: swift run HSOPrototype
      - name: Lint (if installed)
        run: |
          if command -v swiftlint >/dev/null; then
            swiftlint
          else
            echo "swiftlint not installed on runner"
          fi

  ios-tests:
    runs-on: macos-15
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app
      - name: Resolve iOS test destination
        id: simulator
        run: |
          set -euo pipefail
          python3 - <<'PY' >> "${GITHUB_OUTPUT}"
          import json
          import subprocess
          import sys

          try:
              output = subprocess.check_output(
                  ["xcrun", "simctl", "list", "-j", "devices", "available"],
                  text=True,
                  stderr=subprocess.STDOUT,
                  timeout=30
              )
          except subprocess.TimeoutExpired:
              print("Timed out while listing iOS simulator devices.", file=sys.stderr)
              sys.exit(1)
          except subprocess.CalledProcessError as error:
              print("Failed to list iOS simulator devices.", file=sys.stderr)
              print(error.output, file=sys.stderr)
              sys.exit(error.returncode)

          try:
              payload = json.loads(output)
          except json.JSONDecodeError as error:
              print(f"simctl returned non-JSON output: {error}", file=sys.stderr)
              print(output, file=sys.stderr)
              sys.exit(1)

          for runtime in payload.get("devices", {}).values():
              for device in runtime:
                  if device.get("isAvailable") and device.get("name", "").startswith("iPhone"):
                      print(f"destination=platform=iOS Simulator,id={device['udid']}")
                      sys.exit(0)

          print("No available iPhone simulator destination found on runner.", file=sys.stderr)
          sys.exit(1)
          PY
      - name: Run iOS tests (unit + UI)
        run: |
          set -euo pipefail
          xcodebuild \
            -project HomeScreenOptimizerApp.xcodeproj \
            -scheme HomeScreenOptimizeriOS \
            -destination "${{ steps.simulator.outputs.destination }}" \
            -resultBundlePath TestResults.xcresult \
            test
      - name: Upload iOS test bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-results
          path: TestResults.xcresult
          if-no-files-found: warn
